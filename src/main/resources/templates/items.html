<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>メインページ</title>

</head>
<body>


	
	
	<header th:replace="header"></header>

		  
	<!--	  日付表示-->
		<div id="current_date" style="color: white ;font-size:20px">
				   	    <script>
				   	        date = new Date();
				   	        year = date.getFullYear();
				   	        month = date.getMonth() + 1;
				   	        day = date.getDate();
				   	        document.getElementById("current_date").innerHTML = 
							"今日の日付：" + year + "-" + month + "-" + day;
				   	    </script><br><br>
				   	</div>
<!--	確認メッセージ-->
	  <div th:if="${successMessage}" class="alert alert-success">
	    <span th:text="${successMessage}"></span>
	  </div>
	  
<!--	提示メッセージ-->	  
	<div th:if="${warningMessage}" class="alert alert-warning">
	    <p th:text="${warningMessage}" style="white-space: pre-line; color: brown;"></p>
	  </div>
	 

	  <br>
	  				カテゴリー：
	  				<a th:href="@{/shokumane/items(asc=${asc}, show=${show})}">全食品</a>
	  				<th:block th:each="category : ${categories}">
	  				    <a th:href="@{/shokumane/items(categoryId=${category.id}, asc=${asc}, show=${show})}" th:text="${category.name}" 
						style="	display: inline-block; margin: 0 4px; padding: 4px 0;"></a>
	  				</th:block>


				<form id="sortForm" th:action="@{/shokumane/items}" method="get">
				    <input type="hidden" name="categoryId" th:value="${categoryId}">
				    <input type="hidden" name="show" th:value="${show}">
				    <label>
				        <input type="checkbox" name="asc" th:checked="${asc}" onchange="document.getElementById('sortForm').submit()" />
				        消費・賞味期限昇順
				    </label>
				</form>


				<form id="showForm" th:action="@{/shokumane/items}" method="get">
				    <input type="hidden" name="categoryId" th:value="${categoryId}">
					<input type="hidden" name="asc" th:value="${asc}">
				    <label>
						<input type="checkbox" id="showHighlight" name="show" th:checked="${show}" onchange="document.getElementById('showForm').submit()" />
						期限切れ・期限近い食品をハイライト
				    </label>
				</form>
				<br>
<!--冷凍庫	-->
<form id="batchForm1" method="post" >
	<table border="1" style="background-color: #f8d7da;">
		<caption style="font-size: 1.2rem;">冷凍庫</caption>
					<thead>
					<tr><th><input type="checkbox" id="select-all" form="batchForm1"></th>
						<th>食品名</th>
						<th>カテゴリー名</th>
						<th>数量</th>
						<th>単位</th>
						<th>memo</th>
						<th>消費・賞味期限</th>
						<th>更新</th>
						<th>消費</th>
						</tr>
					</thead>
						
					<tbody>
					<tr th:each="food:${foods2}">
						<td><input type="checkbox" class="row-checkbox" name="ids" th:value="${food.id}" form="batchForm1"></td>
						<td th:text="${food.foodName}"></td>
						<td th:text="${food.categoryName}"></td>
						<td th:text="${food.quantity}"></td>
						<td th:text="${food.countName}"></td>
						<td th:text="${food.memo}"></td>
						<td class="time-limit" th:text="${food.timeLimit}"></td>
						<td>
								<button type="submit" class="btn" form="batchForm1" th:formaction="@{/shokumane/{id}/edit(id=${food.id})}" formmethod="get">更新</button>
							</td>
							<td>
								<button type="submit" class="btn"  form="batchForm1" th:formaction="@{/shokumane/{id}/consume(id=${food.id})}" formmethod="get">消費</button>
													
							</td>
					</tr>
					</tbody>
				</table>
	
				<div id="action-buttons" hidden>
				      <button type="submit" formaction="/shokumane/chillmove">冷蔵庫へ移動</button>
				      <button type="submit" formaction="/shokumane/multidelete">消費</button>
				    </div>
</form>

	  <br>
	  
	<form action="/shokumane/add" method="get">
		<button  type="submit" name="action" value="2">冷凍庫に品物を登録</button>
	</form>

<!--冷蔵庫	-->

	<br>

	<form id="batchForm" method="post" >
	<table border="1" style="background-color: #f8d7da;">
		<caption style="font-size: 1.2rem;">冷蔵庫</caption>
				<tr>
					<th><input type="checkbox" id="select-all1" form="batchForm"></th>
					<th>食品名</th>
					<th>カテゴリー名</th>
					<th>数量</th>
					<th>単位</th>
					<th>memo</th>
					<th>消費・賞味期限</th>
					<th>更新</th>
					<th>消費</th>
				</tr>
				<tr th:each="food:${foods1}">
					<td><input type="checkbox" class="row-checkbox1" name="ids" th:value="${food.id}" form="batchForm"></td>
					<td th:text="${food.foodName}"></td>
					<td th:text="${food.categoryName}"></td>
					<td th:text="${food.quantity}"></td>
					<td th:text="${food.countName}"></td>
					<td th:text="${food.memo}"></td>
					<td class="time-limit1" th:text="${food.timeLimit}"></td>
					<td>
							<button type="submit" class="btn" form="batchForm" th:formaction="@{/shokumane/{id}/edit(id=${food.id})}" formmethod="get">更新</button>
					</td>
					<td>
							<button type="submit" class="btn"  form="batchForm" th:formaction="@{/shokumane/{id}/consume(id=${food.id})}" formmethod="get">消費</button>
							
					</td>
				</tr>
			</table>
			
			<div id="action-buttons1" hidden>
							      <button type="submit" formaction="/shokumane/freezemove" formmethod="post">冷凍庫へ移動</button>
							      <button type="submit" formaction="/shokumane/multidelete" formmethod="post">消費</button>
							    </div>
	</form>
	
	<br>
	<form action="/shokumane/add" method="get">
		<button  type="submit" name="action" value="1">冷蔵庫に品物を登録</button>
	</form>

	<script>
	    document.addEventListener("DOMContentLoaded", () => {
	      const now = new Date(); now.setHours(0,0,0,0);
		    

	      function initBatch(selectAllId, rowCheckboxClass, actionButtonsId) {
	        const selectAll = document.getElementById(selectAllId);
	        const rowCheckboxes = document.querySelectorAll("." + rowCheckboxClass);
	        const actionButtons = document.getElementById(actionButtonsId);

	        function updateButtons() {
	          const anyChecked = [...rowCheckboxes].some(cb => cb.checked);
	          actionButtons.hidden = !anyChecked;
	          selectAll.checked = rowCheckboxes.length > 0 && [...rowCheckboxes].every(cb => cb.checked);
	        }

	        selectAll.addEventListener("change", () => {
	          rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
	          updateButtons();
	        });
	        rowCheckboxes.forEach(cb => cb.addEventListener("change", updateButtons));
	      }
	      initBatch("select-all", "row-checkbox", "action-buttons");
	      initBatch("select-all1", "row-checkbox1", "action-buttons1");
		  

		  
			const checkbox = document.getElementById('showHighlight');
			applyOrCleanHighlight(checkbox.checked);

		  		    function applyOrCleanHighlight(apply) {
		  		      document.querySelectorAll("td.time-limit, td.time-limit1").forEach(td => {
		  		        const tr = td.parentElement;
		  		        if (!apply) {
		  		          tr.style.backgroundColor = ''; 
		  		          return;
		  		        }
		  		        const d = new Date(td.textContent.trim());
		  		        if (isNaN(d)) return;
		  		        d.setHours(0,0,0,0);
		  		        const diff = (d - now) / (1000*60*60*24);
		  		        tr.style.backgroundColor = diff < 0 ? 'rgba(255, 111, 97,0.5)'
		  		                              : (diff <= 3 ? 'rgba(229, 255, 0,0.5)' : '');
											  
											 
		  		      });
		  		    }


		  		    applyOrCleanHighlight(checkbox.checked);


		  		    window.toggleHighlight = function(checked) {
		  		      applyOrCleanHighlight(checked);
		  		    };
		  		
	    });
	  </script>
	<footer th:replace="footer"></footer>
</body>
</html>